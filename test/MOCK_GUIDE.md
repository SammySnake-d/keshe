# Mock/Real æ¨¡å¼æµ‹è¯•æŒ‡å—

## ğŸ¯ è®¾è®¡ç†å¿µ

æ‰€æœ‰æµ‹è¯•ä»£ç **å…±ç”¨ä¸€ä¸ª Mock é…ç½®å¼€å…³**ï¼Œé€šè¿‡ä¿®æ”¹ `include/AppConfig.h` ä¸­çš„ `USE_MOCK_HARDWARE` å®æ¥å…¨å±€åˆ‡æ¢ï¼š

```cpp
// include/AppConfig.h
#define USE_MOCK_HARDWARE   1     // 1=Mockæ¨¡å¼, 0=Realç¡¬ä»¶
```

## ğŸ”„ Mock vs Real æ¨¡å¼

### Mock æ¨¡å¼ï¼ˆUSE_MOCK_HARDWARE = 1ï¼‰
- âœ… **æ— éœ€ç¡¬ä»¶**ï¼šå¯ä»¥åœ¨æ²¡æœ‰ç‰©ç†è®¾å¤‡çš„æƒ…å†µä¸‹è¿è¡Œ
- âœ… **å¿«é€ŸéªŒè¯**ï¼šéªŒè¯ç®—æ³•é€»è¾‘æ­£ç¡®æ€§
- âœ… **åœºæ™¯æ¨¡æ‹Ÿ**ï¼šå¯ä»¥æ¨¡æ‹Ÿå„ç§æç«¯æƒ…å†µ
- âœ… **CI/CD å‹å¥½**ï¼šé€‚åˆè‡ªåŠ¨åŒ–æµ‹è¯•

**é€‚ç”¨åœºæ™¯ï¼š**
- å¼€å‘åˆæœŸç®—æ³•éªŒè¯
- æ²¡æœ‰ç¡¬ä»¶æ—¶çš„ä»£ç æµ‹è¯•
- å›å½’æµ‹è¯•å’Œ CI/CD æµæ°´çº¿
- æ¨¡æ‹Ÿæç«¯åœºæ™¯ï¼ˆå¦‚ä½ç”µé‡ã€æ— ä¿¡å·ï¼‰

### Real æ¨¡å¼ï¼ˆUSE_MOCK_HARDWARE = 0ï¼‰
- âœ… **çœŸå®æ•°æ®**ï¼šä½¿ç”¨å®é™…ç¡¬ä»¶é‡‡é›†æ•°æ®
- âœ… **ç¡¬ä»¶éªŒè¯**ï¼šéªŒè¯å¼•è„šè¿æ¥å’Œç”µè·¯è®¾è®¡
- âœ… **æ€§èƒ½æµ‹è¯•**ï¼šæµ‹è¯•çœŸå®ç¯å¢ƒä¸‹çš„æ€§èƒ½
- âœ… **æœ€ç»ˆéªŒè¯**ï¼šç¡®ä¿ç³»ç»Ÿåœ¨å®é™…ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œ

**é€‚ç”¨åœºæ™¯ï¼š**
- ç¡¬ä»¶åˆ°è´§åçš„é›†æˆæµ‹è¯•
- éªŒè¯å¼•è„šè¿æ¥æ­£ç¡®æ€§
- æµ‹è¯•çœŸå®ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§
- äº§å“äº¤ä»˜å‰çš„æœ€ç»ˆéªŒè¯

## ğŸ“ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤ 1ï¼šé…ç½®æ¨¡å¼

ç¼–è¾‘ `include/AppConfig.h`ï¼š

```cpp
// Mock æ¨¡å¼
#define USE_MOCK_HARDWARE   1

// Real æ¨¡å¼
#define USE_MOCK_HARDWARE   0
```

### æ­¥éª¤ 2ï¼šè¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå•ä¸ªæ¨¡å—æµ‹è¯•
pio test -e test-battery

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pio test
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç»“æœ

**Mock æ¨¡å¼è¾“å‡ºç¤ºä¾‹ï¼š**
```
âš™ï¸  å½“å‰æ¨¡å¼: Mockï¼ˆä»¿çœŸï¼‰

[TEST] ç”µå‹è¯»å– [Mock æ¨¡å¼]
  Mock ç”µå‹: 3.80V
âœ“ ç”µå‹è¯»å–æ­£å¸¸

[TEST] ç”µé‡ç™¾åˆ†æ¯”è®¡ç®— [Mock æ¨¡å¼]
  4.0V â†’ 75%
âœ“ ç”µé‡è®¡ç®—æ­£ç¡®

4 Tests 0 Failures 0 Ignored
PASSED
```

**Real æ¨¡å¼è¾“å‡ºç¤ºä¾‹ï¼š**
```
âš™ï¸  å½“å‰æ¨¡å¼: Realï¼ˆçœŸå®ç¡¬ä»¶ï¼‰
   ç¡®ä¿ GPIO 11 å·²è¿æ¥ç”µæ± åˆ†å‹ç”µè·¯

[TEST] ç”µå‹è¯»å– [Real ç¡¬ä»¶]
  å®é™…ç”µå‹: 3.82V
âœ“ ç”µå‹è¯»å–æ­£å¸¸

[TEST] ç”µé‡ç™¾åˆ†æ¯”è®¡ç®— [Real ç¡¬ä»¶]
  å®é™…ç”µå‹: 3.82V â†’ 52%
âœ“ ç”µé‡è®¡ç®—æ­£ç¡®

4 Tests 0 Failures 0 Ignored
PASSED
```

## ğŸ§ª æµ‹è¯•æ¨¡å—åˆ—è¡¨

| æ¨¡å— | Mock ç±» | æµ‹è¯•æ–‡ä»¶ | ç¡¬ä»¶è¦æ±‚ |
|------|---------|----------|----------|
| ç”µæ± ç”µå‹ | `MockBattery` | `test_battery/` | GPIO 11 + åˆ†å‹ç”µè·¯ |
| å€¾æ–œä¼ æ„Ÿå™¨ | `MockLSM6DS3` | `test_lsm6ds3/` | I2C (GPIO 17/18) |
| æ‘„åƒå¤´ | `MockCamera` | `test_ov2640/` | å®Œæ•´å¼•è„šè¿æ¥ + PSRAM |
| 4G æ¨¡å— | `MockEC800K` | `test_ec800k/` | UART (GPIO 4/5/3) |
| GPS | `MockGPS` | `test_gps/` | UART (GPIO 6/7) |
| éŸ³é¢‘ä¼ æ„Ÿå™¨ | `MockAudio` | `test_audio/` | ADC (GPIO 8/19) |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å…ˆ Mock å Real
```
å¼€å‘æµç¨‹ï¼š
1. ç¼–å†™ Mock æµ‹è¯• â†’ éªŒè¯ç®—æ³•é€»è¾‘
2. Mock æµ‹è¯•é€šè¿‡ â†’ åˆ‡æ¢åˆ° Real æ¨¡å¼
3. Real æµ‹è¯•é€šè¿‡ â†’ é›†æˆåˆ°ä¸»é¡¹ç›®
```

### 2. Mock å®ç°è¦çœŸå®
```cpp
// âŒ é”™è¯¯ï¼šMock ç›´æ¥è¿”å›å›ºå®šå€¼
float readBatteryVoltage() {
    return 3.8f;  // å¤ªç®€å•ï¼Œæ— æ³•éªŒè¯ç®—æ³•
}

// âœ… æ­£ç¡®ï¼šMock æ¨¡æ‹ŸçœŸå®è¡Œä¸ºï¼ˆå™ªå£°ã€æŠ–åŠ¨ï¼‰
float readBatteryVoltage() {
    float noise = (random(-20, 20) / 1000.0f);
    return mockVoltage + noise;  // æ¨¡æ‹Ÿ ADC å™ªå£°
}
```

### 3. ä½¿ç”¨æ¡ä»¶ç¼–è¯‘éš”ç¦»å·®å¼‚
```cpp
float readBatteryVoltage() {
#if USE_MOCK_HARDWARE
    return battery.readBatteryVoltage();  // Mock å®ç°
#else
    // Real ç¡¬ä»¶å®ç°
    analogSetPinAttenuation(PIN_BAT_ADC, ADC_11db);
    return analogReadMilliVolts(PIN_BAT_ADC) * BAT_VOLTAGE_DIV / 1000.0f;
#endif
}
```

### 4. æµ‹è¯•ç”¨ä¾‹é€‚é…ä¸¤ç§æ¨¡å¼
```cpp
void test_voltage_reading() {
#if USE_MOCK_HARDWARE
    battery.setMockVoltage(3.8f);
    TEST_ASSERT_FLOAT_WITHIN(0.1f, 3.8f, readBatteryVoltage());
#else
    float voltage = readBatteryVoltage();
    TEST_ASSERT_TRUE(voltage >= 3.0f && voltage <= 4.5f);
#endif
}
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¿®æ”¹ AppConfig.h åæµ‹è¯•ç»“æœæ²¡å˜åŒ–ï¼Ÿ
**A:** éœ€è¦é‡æ–°ç¼–è¯‘æµ‹è¯•ä»£ç ï¼š
```bash
pio test -e test-battery --without-uploading  # å¼ºåˆ¶é‡æ–°ç¼–è¯‘
```

### Q2: Mock æ¨¡å¼æ‰¾ä¸åˆ° Mock ç±»ï¼Ÿ
**A:** ç¡®ä¿ Mock æ–‡ä»¶åœ¨æ­£ç¡®è·¯å¾„ï¼š
```
test/
â”œâ”€â”€ mocks/
â”‚   â”œâ”€â”€ MockBattery.h
â”‚   â”œâ”€â”€ MockLSM6DS3.h
â”‚   â””â”€â”€ ...
â””â”€â”€ test_battery/
    â””â”€â”€ test_battery.cpp  # ä½¿ç”¨ "../mocks/MockBattery.h"
```

### Q3: Real æ¨¡å¼ä¸‹æ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Ÿ
**A:** æ£€æŸ¥ç¡¬ä»¶è¿æ¥ï¼š
1. ç¡®è®¤å¼•è„šè¿æ¥æ­£ç¡®ï¼ˆå‚è€ƒ PinMap.hï¼‰
2. æµ‹é‡ç”µæºç”µå‹æ˜¯å¦æ­£å¸¸
3. ä½¿ç”¨ä¸‡ç”¨è¡¨æµ‹è¯•å¼•è„šé€šæ–­

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

æ¨èçš„æµ‹è¯•æµç¨‹ï¼š

```
1. Mock æµ‹è¯•ï¼ˆå¿…é¡»100%é€šè¿‡ï¼‰
   â”œâ”€â”€ ç®—æ³•é€»è¾‘éªŒè¯
   â”œâ”€â”€ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
   â””â”€â”€ å¼‚å¸¸æƒ…å†µæ¨¡æ‹Ÿ

2. Real æµ‹è¯•ï¼ˆç¡¬ä»¶åˆ°è´§åï¼‰
   â”œâ”€â”€ å¼•è„šè¿æ¥éªŒè¯
   â”œâ”€â”€ æ•°æ®é‡‡é›†å‡†ç¡®æ€§
   â””â”€â”€ é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•

3. é›†æˆæµ‹è¯•
   â”œâ”€â”€ æ¨¡å—é—´é€šä¿¡
   â”œâ”€â”€ å¤šæ¨¡å—åŒæ—¶è¿è¡Œ
   â””â”€â”€ åŠŸè€—å’Œæ€§èƒ½æµ‹è¯•
```

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `include/AppConfig.h` - Mock/Real æ¨¡å¼å¼€å…³
- `include/PinMap.h` - å¼•è„šå®šä¹‰
- `include/Settings.h` - é˜ˆå€¼å’Œå‚æ•°é…ç½®
- `test/mocks/` - Mock å®ç°
- `platformio.ini` - æµ‹è¯•ç¯å¢ƒé…ç½®

---

**æœ€åæ›´æ–°ï¼š** 2026-01-03  
**ç»´æŠ¤è€…ï¼š** AI Assistant
